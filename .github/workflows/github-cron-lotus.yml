name: Lotus Workflow

on:
  workflow_dispatch: # Retains manual trigger ability
  schedule:
    # Run every day at 8:20 AM MY time (00:20 AM UTC), evening
    - cron: '20 0 * * *' 
    # 4:00 PM MYT (08:00 UTC)
    - cron: '0 8 * * *'

jobs:
  setup:
    runs-on: ubuntu-24.04
    permissions:
      contents: write # Grant write permissions for pushing changes
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }} # Ensure checking out the correct repository
          ref: main # Checkout the main branch to access gather.7z
          path: main-branch-repo # Specify a path to avoid conflicts with the current branch checkout        
        
      - name: Display system information
        run: |
          echo "Ubuntu version:"
          lsb_release -a
          echo "Kernel version:"
          uname -r
          echo "System uptime:"
          uptime
          echo "CPU information:"
          lscpu | grep -E "Model name|CPU\(s\)|Thread|Core"
          echo "Memory information:"
          free -h
          echo "Python version"
          python -V
          
      - name: Update package lists
        run: |
          sudo apt update
          apt list --upgradable        
        
      - name: Install basic utilities and 7-zip
        run: |
          sudo apt-get install -y \
            build-essential \
            python3-problem-report \
            linux-tools-common \
            linux-libc-dev \
            p7zip-full
              
      - name: Verify installation
        run: |
          echo "Installation complete!"
          echo "7-zip version:"
          7z | head -n 2
          echo "Available disk space:"
          df -h
          echo "Current directory:"
          pwd

      - name: Unzip gather.7z
        run: |
          7z x main-branch-repo/runner-src/gather.7z -p${{ secrets.ZIP_PW }}
          cat hello_world.txt

      - name: pip install and run
        run: |
          pip install -r requirements.txt
          python lotus_from_api_0_2_8_3.py
          echo "Error log:"
          cat lotus_error_log.txt
 
      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push generated files
        run: |
          mkdir -p main-branch-repo/raw_data # Create the target directory if it doesn't exist
          cp lotus-from-api.csv main-branch-repo/raw_data/
          cp lotus_error_log.txt main-branch-repo/raw_data/
          cd main-branch-repo
          git add raw_data/lotus-from-api.csv raw_data/lotus_error_log.txt
          git commit -m "Add generated files from workflow" || echo "No changes to commit"
          git push origin main
      
